# Codebase Concerns

**Analysis Date:** 2026-02-11

## Tech Debt

**Code Duplication in Moderation Logic:**
- Issue: OpenAI moderation logic (`shouldFlag`, `moderateText`, `moderateTextAndImage`, `arrayBufferToBase64`) is duplicated across multiple files with identical or near-identical implementations
- Files: `src/routes/api/ads/+server.ts`, `src/routes/api/ads/[id]/+server.ts`, `src/cron-worker.ts`
- Impact: Changes to moderation thresholds or logic must be synchronized across three files, increasing risk of inconsistency and bugs
- Fix approach: Extract shared moderation utilities to `src/lib/server/moderation.ts` and import from single source

**Fallback-Only Rate Limiting:**
- Issue: Rate limiting gracefully degrades when KV namespace unavailable (`if (!kv) return { allowed: true }`), allowing unlimited requests during KV outages
- Files: `src/lib/server/rate-limit.ts` (lines 19, 42), `src/routes/api/ads/+server.ts` (line 59 - `warnedMissingRateLimit`)
- Impact: No rate limiting protection during infrastructure failures or local development without KV configured
- Fix approach: Add in-memory fallback rate limiter for development/degraded mode, warn but don't silently allow unlimited access

**Generated Type File Committed:**
- Issue: `src/worker-configuration.d.ts` is an 8,348-line auto-generated file committed to git (generated by `wrangler types`)
- Files: `src/worker-configuration.d.ts`
- Impact: Clutters diffs, increases merge conflicts, may drift from actual Cloudflare Workers runtime
- Fix approach: Add to `.gitignore`, regenerate during CI/build via `npm run cf-typegen`, document in README

**Silent Error Swallowing:**
- Issue: Multiple async operations catch errors and only log warnings without alerting or surfacing to caller
- Files: `src/lib/server/rate-limit.ts` (line 41 - KV errors), `src/lib/server/moderation-events.ts` (line 41 - DB insert failures), `src/cron-worker.ts` (line 90 - catch blocks return 'unavailable')
- Impact: Failures in non-critical paths go unnoticed until investigated manually; no observability into degraded states
- Fix approach: Add structured error reporting/metrics for these silent failures, consider alerting on high error rates

**Test Coverage Imbalance:**
- Issue: 17 test files for 71 source files (24% coverage by file count); large critical files like ads endpoints (867 and 647 lines) lack dedicated tests
- Files: No tests for `src/routes/api/ads/+server.ts`, `src/routes/api/ads/[id]/+server.ts` (only E2E coverage)
- Impact: Complex business logic (rate limiting, moderation, edit backoff) untested at unit level, hard to refactor safely
- Fix approach: Add unit tests for API route handlers using mocked dependencies, prioritize high-complexity files

**Hard-Coded Magic Thresholds:**
- Issue: OpenAI moderation score thresholds hard-coded across three files (e.g., `scores['sexual/minors'] > 0.005`, `scores['sexual'] >= 0.35`)
- Files: `src/routes/api/ads/+server.ts` (lines 91-100), `src/routes/api/ads/[id]/+server.ts` (lines 91-100), `src/cron-worker.ts` (lines 66-78)
- Impact: Tuning moderation sensitivity requires code changes across multiple files; no configuration-driven approach
- Fix approach: Move thresholds to `src/lib/constants.ts` or environment variables, reference single source

## Known Bugs

**None explicitly documented in code comments or tracking system at time of analysis**

## Security Considerations

**Environment Variables Handling:**
- Risk: `.env` file exists and is correctly gitignored, but multiple API routes access sensitive keys without validation
- Files: `src/routes/api/ads/+server.ts` (lines 435-436 access `PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`), `src/cron-worker.ts` (lines 10-14), `src/routes/api/ads/[id]/+server.ts`
- Current mitigation: Cloudflare Workers platform.env bindings, gitignore prevents commits
- Recommendations: Add runtime validation that required secrets exist on startup, fail fast if missing; consider secret rotation documentation

**CSRF Protection Depth:**
- Risk: CSRF protection relies on `isSameOrigin` check for mutation endpoints
- Files: `src/lib/server/csrf.ts` (implementation), called in `src/routes/api/ads/+server.ts` (line 299), `src/routes/api/ads/[id]/+server.ts` (line 285)
- Current mitigation: Origin header validation implemented for all POST/PATCH/DELETE operations
- Recommendations: Document that this assumes SvelteKit's default CSRF protections; add integration tests verifying CSRF rejection

**OpenAI API Key Exposure Surface:**
- Risk: `OPENAI_API_KEY` passed to multiple moderation code paths, duplicated initialization logic
- Files: `src/routes/api/ads/+server.ts` (line 277), `src/routes/api/ads/[id]/+server.ts`, `src/cron-worker.ts` (line 12)
- Current mitigation: Environment variable not logged or returned in responses
- Recommendations: Centralize OpenAI client creation in `src/lib/clients/moderationClient.ts` to reduce surface area for accidental exposure

**User-Generated Content Storage:**
- Risk: Ad images stored in R2 with public CDN access (`PUBLIC_R2_BASE`), pending approval images in separate bucket
- Files: `wrangler.jsonc` (R2 bucket config), `src/routes/api/ads/+server.ts` (image upload logic)
- Current mitigation: Pending ads use private bucket (`ADS_PENDING_BUCKET`), only moved to public after moderation
- Recommendations: Add Content-Security-Policy headers to prevent MIME confusion attacks, document R2 bucket CORS/access policies

## Performance Bottlenecks

**Sequential Image Moderation:**
- Problem: When multiple images uploaded, moderation happens sequentially in cron worker (batch limited to 25 ads, but images processed one by one)
- Files: `src/cron-worker.ts` (lines 27-28 `MAX_IMAGE_CHECK = 3`, sequential processing)
- Cause: Images converted to data URLs and sent to OpenAI API in series
- Improvement path: Parallelize image moderation with `Promise.all`, add timeout per image, aggregate results

**Large Ad Listing Queries:**
- Problem: Ad listing endpoints query all fields from ads table without pagination limit caps
- Files: `src/routes/api/ads/+server.ts` (pagination applied but no max page size enforced)
- Cause: `getPagination` utility in `src/lib/server/pagination.ts` doesn't cap page size
- Improvement path: Add maximum page size (e.g., 100 items), return 400 if exceeded

**Synchronous Data URL Conversion:**
- Problem: `arrayBufferToBase64` processes entire image buffer in single synchronous loop with 32KB chunks
- Files: `src/routes/api/ads/+server.ts` (lines 99-106), `src/routes/api/ads/[id]/+server.ts` (lines 62-77), `src/cron-worker.ts` (lines 41-48)
- Cause: Cloudflare Workers have CPU time limits; large images block execution
- Improvement path: Enforce smaller max image size or use streaming approach, validate before conversion

**Unbounded Database Scans:**
- Problem: Cron worker queries all pending ads without pagination (`BATCH_LIMIT = 25` but no offset/continuation)
- Files: `src/cron-worker.ts` (lines 27, 120-125 - single batch query)
- Cause: If >25 pending ads exist, only first 25 processed per cron run
- Improvement path: Add cursor-based pagination or multiple batches per run with time budget

## Fragile Areas

**Edit Backoff State in KV:**
- Files: `src/routes/api/ads/[id]/+server.ts` (lines 57-60 `EditBackoffState`, lines 356-390 backoff calculation)
- Why fragile: Complex exponential backoff logic depends on KV state consistency; count increment/timing calculation errors could permanently lock user out of editing
- Safe modification: Any changes to backoff calculation must preserve backward compatibility with existing KV entries; add unit tests for all edge cases (first edit, rapid edits, expired TTL)
- Test coverage: No dedicated unit tests for backoff state machine

**Identity Lock System (mythologise + tagToAvatar):**
- Files: `src/lib/utils/mythologise.ts` (523 lines), `src/lib/utils/tag-to-avatar.ts` (341 lines), `src/lib/utils/identity-lock.spec.ts` (365 lines of snapshot tests)
- Why fragile: User identity (display name + avatar) is deterministic hash of userId + secret; any change to noun/adjective lists, hash algorithm, or SVG generation breaks existing user identities
- Safe modification: Lists marked "APPEND ONLY" (line 26 in mythologise.ts); snapshot tests lock fingerprints; never reorder or remove entries
- Test coverage: Excellent - identity-lock.spec.ts has comprehensive snapshot coverage

**Category Profiles Data:**
- Files: `src/lib/category-profiles.ts` (493 lines of bike-specific validation), `src/lib/location-hierarchy.ts` (482 lines)
- Why fragile: Large data structures (bike types, sizes, counties, localities) with validation logic tightly coupled to UI; adding fields or changing structure impacts multiple layers
- Safe modification: Add new categories/profiles incrementally, ensure backward compatibility with existing ads in database
- Test coverage: `src/lib/server/ads-validation.spec.ts` (434 lines) covers validation logic

**Supabase Type Definitions:**
- Files: `src/lib/supabase.types.ts` (536 lines)
- Why fragile: Auto-generated from database schema; manual changes will be overwritten; used throughout codebase for type safety
- Safe modification: Only update via `supabase gen types typescript`, commit changes carefully
- Test coverage: Type-level only (TypeScript compiler checks)

## Scaling Limits

**Cloudflare Workers CPU Time:**
- Current capacity: Cloudflare Workers standard plan has 50ms CPU time limit per request
- Limit: Large ad posts with multiple images + moderation could approach CPU timeout
- Scaling path: Move OpenAI moderation to async background processing (cron worker already does this for pending ads), immediately return "pending" status

**Daily Ad Limit Per User:**
- Current capacity: Hard-coded `ADS_PER_DAY = 12` (line 55 in ads/+server.ts)
- Limit: Power users or legitimate businesses may need higher limits
- Scaling path: Make limit configurable per user tier or category, store in user metadata table

**Cron Worker Batch Size:**
- Current capacity: `BATCH_LIMIT = 25` pending ads processed per scheduled run
- Limit: If ad creation rate exceeds 25/cron-interval, backlog grows unbounded
- Scaling path: Process multiple batches per cron run with time budget, or increase batch size with parallel processing

**R2 Storage Costs:**
- Current capacity: Images stored indefinitely in R2 (`ADS_BUCKET` and `ADS_PENDING_BUCKET`)
- Limit: Rejected/expired ads leave orphaned images in pending bucket
- Scaling path: Add lifecycle policies to auto-delete pending bucket images after N days, clean up expired ad images from public bucket

## Dependencies at Risk

**Wrangler (Cloudflare):**
- Risk: Generates 8,348 lines of runtime types (`worker-configuration.d.ts`), breaking changes in Cloudflare Workers runtime could invalidate code
- Impact: Build failures, runtime errors in production if compatibility_flags drift
- Migration plan: Pin `compatibility_date` in wrangler.jsonc (currently `2025-08-23`), test before updating

**OpenAI SDK:**
- Risk: `openai` package at 6.18.0; moderation API endpoint/scoring changes could alter behavior
- Impact: False positives/negatives in content moderation if OpenAI changes model scoring
- Migration plan: Pin exact version, monitor OpenAI API changelogs, add integration tests with known flagged content

**SvelteKit on Cloudflare Adapter:**
- Risk: `@sveltejs/adapter-cloudflare` at 7.2.6; SvelteKit/adapter breaking changes could affect routing or platform bindings
- Impact: Deployment failures, platform.env access patterns breaking
- Migration plan: Test adapter updates in preview environment before production, review SvelteKit migration guides

## Missing Critical Features

**No Image Optimization Pipeline:**
- Problem: Images uploaded as-is to R2 without resizing, format conversion, or compression
- Blocks: Mobile performance optimization, bandwidth cost reduction
- Related files: `src/routes/api/ads/+server.ts` (image upload), `MAX_IMAGE_SIZE` constant

**No User Notification System:**
- Problem: No email/push notifications for moderation decisions, message replies, or ad status changes
- Blocks: User engagement, transparent moderation communication
- Related files: `src/lib/server/moderation-emails.ts` exists but only generates email bodies, no sending infrastructure

**No Rate Limiting for Read Operations:**
- Problem: Rate limiting only applied to mutations (POST/PATCH), not reads (GET /api/ads could be DDoS target)
- Blocks: Protection against scraping, abuse, API overload
- Related files: `src/lib/server/rate-limit.ts` (only called in mutation endpoints)

**No Admin Audit Logging:**
- Problem: Admin actions on reports/appeals recorded in `moderation_events` table, but no immutable audit log for accountability
- Blocks: Compliance requirements, admin abuse detection
- Related files: `src/lib/server/moderation-events.ts` (records events but no admin action tracking)

## Test Coverage Gaps

**API Route Handlers:**
- What's not tested: Core ad creation/editing logic in `POST /api/ads`, `PATCH /api/ads/[id]`
- Files: `src/routes/api/ads/+server.ts` (867 lines, no unit tests), `src/routes/api/ads/[id]/+server.ts` (647 lines, no unit tests)
- Risk: Complex validation, rate limiting, moderation flow could break without detection
- Priority: High - these are critical user-facing features

**Rate Limiting Logic:**
- What's not tested: Edge cases in KV-based rate limiter (concurrent requests, TTL expiration, counter rollover)
- Files: `src/lib/server/rate-limit.ts` has `rate-limit.spec.ts` but only 5 async/await occurrences (limited coverage)
- Risk: Rate limiting bypass under load or edge case conditions
- Priority: High - security-critical functionality

**Moderation Events Recording:**
- What's not tested: Database insert failures, event payload validation
- Files: `src/lib/server/moderation-events.ts` has `moderation-events.spec.ts` (2 test occurrences)
- Risk: Silent failures in moderation audit trail
- Priority: Medium - impacts compliance but not user-facing functionality

**Cron Worker Logic:**
- What's not tested: Batch processing, image moderation workflow, error handling
- Files: `src/cron-worker.ts` (348 lines, no unit tests)
- Risk: Background job failures go unnoticed until manual investigation
- Priority: Medium - impacts pending ad approval times

**Category Profile Validation:**
- What's not tested: Location hierarchy (counties, localities), bike profile variations
- Files: `src/lib/location-hierarchy.ts` (482 lines, no dedicated tests), `src/lib/category-profiles.ts` (493 lines, validation covered in ads-validation.spec.ts)
- Risk: Invalid data structures or edge cases in form validation
- Priority: Low - mostly static data, but edge cases may exist

---

*Concerns audit: 2026-02-11*
